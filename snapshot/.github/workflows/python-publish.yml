name: Upload Python Package

on:
  push:
    tags:
      - '*@v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Parse Scoped Tag
      id: parse
      run: |
        # 标签格式示例: pyquipu-engine@v0.1.1
        TAG_NAME=${{ github.ref_name }}
        if [[ $TAG_NAME == *"@"* ]]; then
          PKG_NAME=$(echo $TAG_NAME | cut -d'@' -f1)
          VERSION=$(echo $TAG_NAME | cut -d'@' -f2)
        else
          # 如果标签不含 @ (例如 v0.1.1), 默认构建元包
          PKG_NAME="pyquipu"
          VERSION=$TAG_NAME
        fi
        
        echo "Detected Package: $PKG_NAME"
        echo "Detected Version: $VERSION"
        echo "pkg_name=$PKG_NAME" >> $GITHUB_OUTPUT

    - name: Build and Publish
      run: |
        PKG_NAME=${{ steps.parse.outputs.pkg_name }}
        rm -rf dist/
        
        if [ -d "packages/$PKG_NAME" ]; then
          echo "Building sub-package: $PKG_NAME"
          uv build packages/$PKG_NAME
        else
          echo "Building root package or custom tag: $PKG_NAME"
          uv build .
        fi

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}